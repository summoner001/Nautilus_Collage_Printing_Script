#!/usr/bin/env bash

# Kijelölt fájlok beolvasása és debug
IFS=$'\n' read -d '' -r -a selected_files <<< "$NAUTILUS_SCRIPT_SELECTED_FILE_PATHS"
echo "Kijelölt fájlok:" > /tmp/collage_debug.log
printf "%s\n" "${selected_files[@]}" >> /tmp/collage_debug.log

# Abszolút elérési utak konvertálása
image_files=()
for file in "${selected_files[@]}"; do
    if [[ "$file" =~ \.(jpg|jpeg|png|webp|bmp|tiff)$ ]]; then
        abs_path="$(realpath "$file")"
        [ -f "$abs_path" ] && image_files+=("$abs_path") || echo "Nem létező fájl: $file" >> /tmp/collage_debug.log
    fi
done

[ ${#image_files[@]} -eq 0 ] && {
    zenity --error --width=400 --text="Nincsenek érvényes képek!\nEllenőrizd a kiterjesztéseket (JPG, PNG, WEBP, BMP, TIFF).\nRészletek: /tmp/collage_debug.log"
    exit 1
}

# GUI beállítások
settings=$(zenity --forms --title="Kollázs Beállítások" --width=400 \
    --text="Alapbeállítások" \
    --add-entry="Oszlopok száma (pl. 2):" \
    --add-entry="Sorok száma (pl. 3):" \
    --add-combo="Papírméret" --combo-values="A4|A5|Letter" \
    --add-combo="Tájolás" --combo-values="Álló|Fekvő" \
    --add-combo="Képtípus" --combo-values="Eredeti|Négyzet|Szélesvásznú" \
    --separator="|")

[ -z "$settings" ] && exit 0

# Beállítások feldolgozása
cols=$(echo "$settings" | cut -d '|' -f1)
rows=$(echo "$settings" | cut -d '|' -f2)
paper_size=$(echo "$settings" | cut -d '|' -f3 | tr '[:upper:]' '[:lower:]')
orientation=$(echo "$settings" | cut -d '|' -f4)
img_type=$(echo "$settings" | cut -d '|' -f5)

# Képarány beállítás
case "$img_type" in
    "Négyzet") geometry="1000x1000^" ;;
    "Szélesvásznú") geometry="1600x900^" ;;
    *) geometry="1000x1000>" ;;  # Eredeti arány megőrzése
esac

# PDF generálás - explicit képparaméterekkel
temp_pdf=$(mktemp /tmp/collage_XXXXXX.pdf)

echo "Montage parancs:" >> /tmp/collage_debug.log
echo "montage -tile \"${cols}x${rows}\" -geometry \"$geometry+20+20\" -background white -density 150 -units PixelsPerInch \"${image_files[@]}\" -page \"${paper_size}${orientation}\" \"$temp_pdf\"" >> /tmp/collage_debug.log

montage -tile "${cols}x${rows}" \
    -geometry "$geometry+20+20" \
    -background white \
    -density 150 \
    -units PixelsPerInch \
    "${image_files[@]}" \
    -page "${paper_size}${orientation}" \
    "$temp_pdf" 2>&1 >> /tmp/collage_debug.log

# Eredmény ellenőrzése
if [ ! -s "$temp_pdf" ]; then
    zenity --error --width=500 --text="Hiba történt!\nA generált PDF üres.\nEllenőrizd a képeket és a debug logot:\n/tmp/collage_debug.log"
    exit 1
fi

# Sikeres művelet után mentési lehetőségek
choice=$(zenity --list --title="Sikeres generálás" --width=450 --height=220 \
    --text="Kollázs készült (Méret: $(du -h "$temp_pdf" | cut -f1))\nMit szeretnél tenni?" \
    --column="Opció" "Megnyitás" "Mentés" "Nyomtatás")

case "$choice" in
    "Megnyitás")
        if command -v evince >/dev/null; then
            evince "$temp_pdf" &
        else
            xdg-open "$temp_pdf" &
        fi
        ;;
    "Mentés")
        target_file=$(zenity --file-selection --save --confirm-overwrite \
            --filename="${default_dir}/Kollazs_$(date +%Y%m%d).pdf" \
            --title="PDF mentése")
        [ -n "$target_file" ] && mv "$temp_pdf" "$target_file"
        ;;
    "Nyomtatás")
        lp "$temp_pdf" | zenity --progress --pulsate --text="Nyomtatás..." --auto-close
        ;;
    *)
        rm "$temp_pdf"
        ;;
esac
